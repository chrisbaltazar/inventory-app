{% extends 'base.html.twig' %}

{% block title %}Código de acceso{% endblock %}

{% block stylesheets %}
    {{ parent() }}

    <style>
        .countdown-timer {
            font-size: 2rem;
            color: #007bff;
            min-height: 3rem;
        }
    </style>
{% endblock %}

{% block body %}

    <div class="row">
        <div class="col-sm-10 offset-sm-1 col-md-8 offset-md-2">
            <h1 class="h3 mb-3 fw-normal text-center">Código de acceso</h1>
            <img class="mb-4 w-100" src="{{ asset('img/logo.PNG') }}" alt="">

            <form method="POST" action="{{ path('app_login_code') }}" data-turbo="false">
                <input type="hidden" name="csrf_token" value="{{ csrf_token('access_code') }}">
                <h6 class="text-center">Introduce el código que se ha enviado a tu teléfono
                    con terminación: <strong>{{ number }}</strong></h6>

                <div class="d-flex justify-content-center my-3">
                    {% for i in range(1, length) %}
                        <input type="number" min="0" max="9" step="1" name="code[]"
                               class="form-control form-control-lg text-center mx-1 js-code-digit" required autofocus>
                    {% endfor %}
                </div>

                <div class="countdown-timer text-center mb-3">
                    <span class="timer"></span>
                </div>

                <button class="mt-3 w-100 btn btn-lg btn-success" type="submit">Verificar</button>
                <a href="{{ path('app_login') }}" class="mt-3 w-100 btn btn-link">Volver a login</a>
            </form>

        </div>
    </div>

    <script>
        document.addEventListener('turbo:load', () => {
            let time = {{ time }}
                setInterval(() => {
                    setClockTimer(time--)
                    if (time < 0) {
                        window.location.href = "{{ path('app_login') }}"
                    }
                }, 1000)

            document.querySelectorAll('.js-code-digit').forEach(function (el) {
                if (el.dataset.bound) return

                el.addEventListener('keyup', function (e) {
                    const value = e.currentTarget.value
                    const next = e.currentTarget.nextElementSibling
                    if (value && next) {
                        next.focus()
                    }
                })

                el.dataset.bound = 'true'
            })
        })

        const setClockTimer = (time) => {
            const minutes = Math.floor(time / 60)
            const seconds = time % 60
            const timer = document.querySelector('.countdown-timer .timer')
            timer.innerText = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`
        }
    </script>

{% endblock %}


